# 동시성 문제 해결 방법

## 동시성 문제란?
동시성 문제는 여러 스레드가 같은 자원에 동시에 접근하여 데이터의 일관성이 깨지는 상황을 말합니다. 이러한 문제는 데이터를 조회하고 수정하는 과정에서 발생할 수 있습니다. 예를 들어, 다음과 같은 경우에 문제가 발생할 수 있습니다:

- **잔액 충전/사용 (결제)**
  - 사용자 기존 포인트 조회
  - 사용자 포인트 업데이트
  - 실수로 동시에 여러 번 클릭해도 실제 여러 번 충전/사용한 것인지, 실수인지를 알아서 잘 저장해야 함

## 동시성 문제 해결 방법

### 1. Lock 사용
Lock은 한 스레드가 자원에 접근해 있을 때 다른 스레드들이 같은 자원에 동시에 접근하지 못하게 막아주는 개념입니다. 주로 사용하는 Lock의 종류는 다음과 같습니다:

- **DB Lock**: 데이터베이스에서 제공하는 Lock 기능을 사용합니다.
- **분산 Lock**: Redis와 같은 분산 시스템에서 제공하는 Lock 기능을 사용합니다.

DB Lock을 활용하여 동시성 문제를 해결 할 수 있고, 이후에 분산 Lock으로도 처리해보아 어떤 방법이 더 효과적인지 비교할 예정입니다.

### 2. 낙관적 Lock (Optimistic Lock)
낙관적 Lock은 DB Lock을 사용하지 않고 Version 관리를 통해 애플리케이션 레벨에서 처리하는 방법입니다. 주로 트랜잭션 충돌이 적을 때 유용합니다.

- JPA에서 제공하는 버전 관리 기능을 사용합니다.
- 트랜잭션 커밋 전에는 트랜잭션 충돌을 알 수 없습니다.
- 최초 하나의 요청만 성공하고 나머지 요청은 `ObjectOptimisticLockingFailureException` 예외를 발생시킵니다.

### 3. 비관적 Lock (Pessimistic Lock)
비관적 Lock은 모든 트랜잭션에서 충돌이 발생한다고 가정하고, 우선 DB Lock을 거는 방법입니다.

- 트랜잭션 커밋 전 데이터 수정 시점에 충돌을 감지합니다.
- Lock을 획득할 때까지 트랜잭션은 대기하므로 Timeout을 설정할 수 있습니다.
- Lock을 얻는 순서대로 요청을 처리합니다.

## 결론
동시성 문제는 데이터의 일관성을 유지하기 위해 반드시 해결해야 할 중요한 이슈입니다. 다양한 Lock 기법을 통해 이러한 문제를 효과적으로 관리할 수 있으며, 상황에 따라 적절한 방법을 선택하는 것이 중요합니다.
